<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geography Quiz + QR + Join + Live Leaderboard</title>

  <!-- QR generator library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/[email protected]/dist/confetti.browser.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 820px; margin: 0 auto; padding: 18px; background: #f6f7fb; }
    .card { background: #fff; border-radius: 14px; padding: 18px; box-shadow: 0 6px 20px rgba(0,0,0,.08); margin-bottom: 14px; }
    h1 { margin: 0 0 8px; }
    .join-screen { text-align: center; }
    #qrcode { display: inline-block; padding: 10px; background: #fff; border-radius: 12px; border: 1px solid #eee; margin: 10px 0; }
    #qrStatus { color: #666; font-size: 14px; margin-top: 6px; }
    .small { color: #666; font-size: 14px; }
    #quiz-container { display: none; }

    .meta { display:flex; justify-content:space-between; color:#666; font-size:14px; margin-bottom:8px; gap:10px; flex-wrap:wrap; }
    .question { font-size: 20px; margin: 10px 0 10px; }

    ul { list-style: none; padding: 0; margin: 0; }
    .option { padding: 12px 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin: 10px 0; cursor: pointer; background: #fafafa; user-select: none; }
    .option:hover { background: #f1f5ff; }
    .option.disabled { cursor: default; opacity: .9; }
    .option.correct { background: #e8f7ee; border-color: #2ecc71; }
    .option.incorrect { background: #fdecec; border-color: #e74c3c; }

    .explanation { display:none; margin-top:12px; padding:12px; border-left:4px solid #2ecc71; background:#f2fbf5; border-radius:10px; color:#1f6b3c; }

    .actions { margin-top: 14px; display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }
    button { border: 0; border-radius: 10px; padding: 11px 14px; cursor: pointer; font-weight: 600; }
    .primary { background: #4f46e5; color: #fff; }
    .primary:disabled { background: #b8b5ff; cursor: not-allowed; }
    .secondary { background: #eef2ff; color: #3730a3; }

    #results { display:none; text-align:center; }
    #score { font-size: 40px; font-weight: 800; margin: 8px 0; color: #111827; }

    .field { margin-top:10px; display:grid; gap:6px; justify-content:center; }
    input[type="text"] { padding:10px; border-radius:10px; border:1px solid #e5e7eb; width: min(320px, 90vw); font-size:16px; }

    #leaderboardBox { margin-top: 12px; }
    #leaderboard { font-size: 14px; color: #111827; line-height: 1.5; }
    .lb-row { display:flex; justify-content:space-between; gap:12px; padding: 6px 0; border-bottom: 1px solid #f1f1f1; }
    .lb-row:last-child { border-bottom: 0; }
    .pill { font-size:12px; color:#3730a3; background:#eef2ff; padding:3px 8px; border-radius:999px; }

    #resultFX { margin-top: 12px; min-height: 60px; }
  </style>
</head>

<body>
  <div id="join-screen" class="card join-screen">
    <h1>Geography Quiz</h1>
    <div class="small">Scan the QR code to open this quiz on your phone.</div>
    <div id="qrcode" aria-label="QR code"></div>
    <div id="qrStatus"></div>

    <div class="field">
      <label class="small" for="playerName">Your name</label>
      <input id="playerName" type="text" placeholder="e.g. Pat" autocomplete="nickname" />
      <div class="small">Game: <span id="gameLabel"></span></div>
    </div>

    <div class="actions" style="justify-content:center">
      <button class="primary" onclick="startQuiz()">Start quiz</button>
    </div>

    <div class="small" style="margin-top:10px;">
      Tip: If QR still doesn't show, refresh (Ctrl/Cmd + Shift + R).
    </div>
  </div>

  <div id="quiz-container" class="card">
    <div id="quiz">
      <div class="meta">
        <div>Question <span id="qnum">1</span>/<span id="qtotal">10</span></div>
        <div>Score <span id="scoreLive">0</span></div>
        <div>Player <span id="whoami" class="pill"></span></div>
      </div>

      <div id="question" class="question"></div>
      <ul id="options"></ul>

      <div id="leaderboardBox" class="card">
        <div style="font-weight:700; margin-bottom:6px;">Leaderboard</div>
        <div id="leaderboard" class="small">Connecting...</div>
      </div>

      <div id="explanation" class="explanation"></div>

      <div class="actions">
        <button class="secondary" onclick="restart()">Restart</button>
        <button id="nextBtn" class="primary" onclick="nextQuestion()" disabled>Next</button>
      </div>
    </div>

    <div id="results">
      <h2>Finished!</h2>
      <div id="score"></div>
      <div id="resultFX"></div>
      <div class="small">Refresh or press Restart to try again.</div>
      <div class="actions" style="justify-content:center">
        <button class="primary" onclick="restart()">Play again</button>
      </div>
    </div>
  </div>

  <script>
    // ---- CONFIG (same as your file) ----
    // Must be https... for GitHub Pages to avoid mixed content blocking.
    const SOCKET_SERVER_URL = "https://quiz-leaderboard-server-1.onrender.com";
    // -----------------------------------

    const quizData = [
      { q: "What is the capital of France?", opts: ["London", "Paris", "Berlin", "Madrid"], correct: 1, exp: "Paris is the capital and largest city of France." },
      { q: "Which continent is the largest by land area?", opts: ["Asia", "Africa", "North America", "Europe"], correct: 0, exp: "Asia covers about 30% of Earth's land area." },
      { q: "What is the longest river in the world?", opts: ["Amazon River", "Nile River", "Yangtze River", "Mississippi River"], correct: 1, exp: "The Nile River flows through northeastern Africa." },
      { q: "Which country has the most population?", opts: ["China", "United States", "India", "Indonesia"], correct: 2, exp: "India surpassed China in 2023 as the most populous nation." },
      { q: "What is the smallest country by land area?", opts: ["Monaco", "Nauru", "Tuvalu", "Vatican City"], correct: 3, exp: "Vatican City is an enclave within Rome, Italy." },
      { q: "Which ocean is the largest?", opts: ["Pacific Ocean", "Atlantic Ocean", "Indian Ocean", "Arctic Ocean"], correct: 0, exp: "The Pacific Ocean covers more than 30% of Earth's surface." },
      { q: "Mount Everest is located in which mountain range?", opts: ["Andes", "Himalayas", "Rockies", "Alps"], correct: 1, exp: "It forms the border between Nepal and China." },
      { q: "What is the capital of Australia?", opts: ["Sydney", "Melbourne", "Canberra", "Perth"], correct: 2, exp: "Canberra was chosen as a compromise between Sydney and Melbourne." },
      { q: "Which desert is the largest hot desert?", opts: ["Sahara Desert", "Gobi Desert", "Kalahari Desert", "Arabian Desert"], correct: 0, exp: "It spans much of northern Africa." },
      { q: "How many continents are there?", opts: ["5", "7", "6", "8"], correct: 1, exp: "The seven continents are Asia, Africa, North America, South America, Antarctica, Europe, and Australia." }
    ];

    // Game id in URL so all players join same room
    const params = new URLSearchParams(location.search);
    const gameId = params.get("game") || makeGameId();
    document.getElementById("gameLabel").textContent = gameId;

    function ensureGameParam() {
      const p = new URLSearchParams(location.search);
      if (!p.get("game")) {
        const url = new URL(location.href);
        url.searchParams.set("game", gameId);
        history.replaceState({}, "", url.toString());
      }
    }
    ensureGameParam();

    let idx = 0;
    let score = 0;
    let answered = false;
    let myName = "";

    // Store latest leaderboard snapshot (used to decide current #1)
    let latestLeaderboard = [];

    // Socket.IO
    const socket = io(SOCKET_SERVER_URL, { transports: ["websocket", "polling"] });

    socket.on("connect", () => setLeaderboardText("Connected. Enter your name and press Start."));
    socket.on("connect_error", () => setLeaderboardText("Cannot reach leaderboard server."));

    socket.on("leaderboardUpdate", (rows) => {
      latestLeaderboard = Array.isArray(rows) ? rows : [];
      renderLeaderboard(rows);
    });

    function setLeaderboardText(text) {
      const el = document.getElementById("leaderboard");
      if (el) el.textContent = text;
    }

    function renderLeaderboard(rows) {
      const el = document.getElementById("leaderboard");
      if (!el) return;

      if (!Array.isArray(rows) || rows.length === 0) {
        el.textContent = "No players yet.";
        return;
      }

      el.innerHTML = rows.map((r, i) => {
        const me = (r.name === myName) ? " (you)" : "";
        const progress = (typeof r.qIndex === "number") ? `Q${r.qIndex + 1}` : "";
        return `
          <div class="lb-row">
            <div>${i + 1}. ${escapeHtml(r.name)}${me}</div>
            <div><span class="pill">${Number(r.score ?? 0)}</span> <span class="small">${escapeHtml(progress)}</span></div>
          </div>
        `;
      }).join("");
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    function makeGameId() {
      return Math.random().toString(36).slice(2, 8).toUpperCase();
    }

    function renderQR() {
      const holder = document.getElementById("qrcode");
      const status = document.getElementById("qrStatus");

      holder.innerHTML = "";
      if (!window.QRCode) {
        status.textContent = "QRCode library did not load.";
        return;
      }

      const url = new URL(window.location.href);
      url.searchParams.set("game", gameId);

      new QRCode(holder, {
        text: url.toString(),
        width: 220,
        height: 220,
        correctLevel: QRCode.CorrectLevel.M
      });

      status.textContent = "";
    }

    window.addEventListener("load", renderQR);

    function startQuiz() {
      const input = document.getElementById("playerName");
      myName = (input.value || "").trim();
      if (!myName) {
        alert("Please enter your name");
        return;
      }

      document.getElementById("whoami").textContent = myName;

      // Join room
      socket.emit("joinGame", { gameId, playerName: myName });

      document.getElementById("join-screen").style.display = "none";
      document.getElementById("quiz-container").style.display = "block";

      document.getElementById("qtotal").textContent = String(quizData.length);
      idx = 0;
      score = 0;
      document.getElementById("scoreLive").textContent = "0";

      document.getElementById("results").style.display = "none";
      document.getElementById("quiz").style.display = "block";

      // Send initial state so you appear on the board immediately
      socket.emit("scoreUpdate", { gameId, playerName: myName, score, qIndex: idx });

      loadQuestion();
    }

    function loadQuestion() {
      answered = false;

      const q = quizData[idx];
      document.getElementById("qnum").textContent = String(idx + 1);
      document.getElementById("question").textContent = q.q;

      const ul = document.getElementById("options");
      ul.innerHTML = "";

      q.opts.forEach((text, optIndex) => {
        const li = document.createElement("li");
        li.className = "option";
        li.textContent = String.fromCharCode(65 + optIndex) + ". " + text;
        li.addEventListener("click", () => choose(optIndex, li));
        ul.appendChild(li);
      });

      const exp = document.getElementById("explanation");
      exp.style.display = "none";
      exp.textContent = "";

      const nextBtn = document.getElementById("nextBtn");
      nextBtn.disabled = true;
      nextBtn.textContent = (idx === quizData.length - 1) ? "Finish" : "Next";

      // Update progress even before answering so board shows who is on what question
      if (myName) socket.emit("scoreUpdate", { gameId, playerName: myName, score, qIndex: idx });
    }

    function choose(optIndex, element) {
      if (answered) return;
      answered = true;

      const q = quizData[idx];
      const all = Array.from(document.querySelectorAll("#options .option"));
      all.forEach(li => li.classList.add("disabled"));

      if (optIndex === q.correct) {
        element.classList.add("correct");
        score += 1;
        document.getElementById("scoreLive").textContent = String(score);
      } else {
        element.classList.add("incorrect");
        if (all[q.correct]) all[q.correct].classList.add("correct");
      }

      // Emit live score update after each question
      if (myName) socket.emit("scoreUpdate", { gameId, playerName: myName, score, qIndex: idx });

      const exp = document.getElementById("explanation");
      exp.textContent = q.exp;
      exp.style.display = "block";

      document.getElementById("nextBtn").disabled = false;
    }

    function nextQuestion() {
      if (!answered) return;
      idx += 1;
      if (idx >= quizData.length) showResults();
      else loadQuestion();
    }

    // Winner logic: "currently #1" means your score equals the highest score
    // in the latest leaderboard snapshot. If tied, all tied winners get confetti.
    function getTopScore(rows) {
      if (!Array.isArray(rows) || rows.length === 0) return null;
      return rows.reduce((max, r) => Math.max(max, Number(r.score ?? 0)), -Infinity);
    }

    function fireWinnerConfetti() {
      if (typeof confetti !== "function") return;
      confetti({ particleCount: 160, spread: 70, origin: { y: 0.6 } });
      setTimeout(() => confetti({ particleCount: 120, spread: 100, origin: { y: 0.6 } }), 250);
    }

    function showLoserThumbsDown() {
      const fx = document.getElementById("resultFX");
      if (!fx) return;

      fx.innerHTML = `
        <div style="display:inline-flex; align-items:center; gap:10px; color:#b91c1c; font-weight:800;">
          <svg xmlns="http://www.w3.org/2000/svg" width="52" height="52" fill="currentColor"
            class="bi bi-hand-thumbs-down" viewBox="0 0 16 16" aria-label="Thumbs down">
            <path d="M8.864 15.674c-.956.24-1.843-.484-1.908-1.42-.072-1.05-.23-2.015-.428-2.59-.125-.36-.479-1.012-1.04-1.638-.557-.624-1.282-1.179-2.131-1.41C2.685 8.432 2 7.85 2 7V3c0-.845.682-1.464 1.448-1.546 1.07-.113 1.564-.415 2.068-.723l.048-.029c.272-.166.578-.349.97-.484C6.931.08 7.395 0 8 0h3.5c.937 0 1.599.478 1.934 1.064.164.287.254.607.254.913 0 .152-.023.312-.077.464.201.262.38.577.488.9.11.33.172.762.004 1.15.069.13.12.268.159.403.077.27.113.567.113.856s-.036.586-.113.856c-.035.12-.08.244-.138.363.394.571.418 1.2.234 1.733-.206.592-.682 1.1-1.2 1.272-.847.283-1.803.276-2.516.211a10 10 0 0 1-.443-.05 9.36 9.36 0 0 1-.062 4.51c-.138.508-.55.848-1.012.964z"/>
          </svg>
          <span>Not #1 this time</span>
        </div>
      `;
    }

    function showResults() {
      document.getElementById("quiz").style.display = "none";
      document.getElementById("results").style.display = "block";
      document.getElementById("score").textContent = `${score}/${quizData.length}`;

      const fx = document.getElementById("resultFX");
      if (fx) fx.innerHTML = "";

      const topScore = getTopScore(latestLeaderboard);
      const iAmWinner = (topScore !== null) && (score === topScore);

      if (iAmWinner) fireWinnerConfetti();
      else showLoserThumbsDown();

      // Final push
      if (myName) socket.emit("scoreUpdate", { gameId, playerName: myName, score, qIndex: quizData.length });
    }

    function restart() {
      document.getElementById("quiz-container").style.display = "none";
      document.getElementById("join-screen").style.display = "block";
      renderQR();
    }
  </script>
</body>
</html>
