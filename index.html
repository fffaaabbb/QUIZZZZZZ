<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Geography Quiz (QR Join + Live Leaderboard)</title>

  <!-- QR generator library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; max-width: 820px; margin: 0 auto; padding: 18px; background: #f6f7fb; }
    .card { background: #fff; border-radius: 14px; padding: 18px; box-shadow: 0 6px 20px rgba(0,0,0,.08); margin-bottom: 14px; }
    h1 { margin: 0 0 8px; }
    .join-screen { text-align: center; }
    #qrcode { display: inline-block; padding: 10px; background: #fff; border-radius: 12px; border: 1px solid #eee; margin: 10px 0; }
    #qrStatus { color:#666; font-size: 14px; margin-top: 6px; }
    .small { color:#666; font-size: 14px; }
    #quiz-container { display: none; }

    .meta { display:flex; justify-content:space-between; color:#666; font-size: 14px; margin-bottom: 8px; gap: 10px; flex-wrap: wrap; }
    .question { font-size: 20px; margin: 10px 0 10px; }
    ul { list-style: none; padding: 0; margin: 0; }
    .option { padding: 12px 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin: 10px 0; cursor: pointer; background: #fafafa; user-select: none; }
    .option:hover { background: #f1f5ff; }
    .option.disabled { cursor: default; opacity: .9; }
    .option.correct { background: #e8f7ee; border-color: #2ecc71; }
    .option.incorrect { background: #fdecec; border-color: #e74c3c; }

    .explanation { display: none; margin-top: 12px; padding: 12px; border-left: 4px solid #2ecc71; background: #f2fbf5; border-radius: 10px; color: #1f6b3c; }
    .actions { margin-top: 14px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    button { border: 0; border-radius: 10px; padding: 11px 14px; cursor: pointer; font-weight: 600; }
    .primary { background: #4f46e5; color: #fff; }
    .primary:disabled { background: #b8b5ff; cursor: not-allowed; }
    .secondary { background: #eef2ff; color: #3730a3; }

    #results { display: none; text-align: center; }
    #score { font-size: 40px; font-weight: 800; margin: 8px 0; color: #111827; }

    .field { margin-top: 10px; display: grid; gap: 6px; justify-content: center; }
    input[type="text"]{ padding: 10px; border-radius: 10px; border: 1px solid #e5e7eb; width: min(360px, 90vw); font-size: 16px; text-align: center; }
    .row { display:flex; gap:10px; justify-content:center; flex-wrap: wrap; }
    .pill { font-size: 12px; color:#3730a3; background:#eef2ff; padding: 3px 8px; border-radius: 999px; }

    #leaderboardBox { margin-top: 12px; }
    #leaderboard { font-size: 14px; color: #111827; line-height: 1.5; }
    .lb-row { display:flex; justify-content:space-between; gap:12px; padding: 6px 0; border-bottom: 1px solid #f1f1f1; }
    .lb-row:last-child { border-bottom: 0; }
    .hint { max-width: 680px; margin: 8px auto 0; }
  </style>
</head>

<body>
  <div id="join-screen" class="card join-screen">
    <h1>Geography Quiz</h1>

    <div class="small">
      The QR code is constant (for your YouTube video). To play together, one person creates a numeric game code and everyone joins that same code.
    </div>

    <div id="qrcode" aria-label="QR code"></div>
    <div id="qrStatus"></div>

    <div class="field">
      <label class="small" for="playerName">Your name</label>
      <input id="playerName" type="text" placeholder="e.g. Pat" autocomplete="nickname" style="text-align:left;" />

      <label class="small" for="gameInput">Game code (format 123-456)</label>
      <input id="gameInput" type="text" placeholder="Create a new game (or type 123-456)" inputmode="numeric" />

      <div class="small">Current game: <span id="gameLabel" class="pill">None</span></div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="secondary" onclick="createNewGame()">Create new game</button>
      <button class="secondary" onclick="useEnteredGame()">Join typed code</button>
      <button class="primary" onclick="startQuiz()">Start quiz</button>
    </div>

    <div class="small hint">
      Tip: Share the game code shown above. Everyone scans the same QR and types the same code to join the same live leaderboard.
    </div>
  </div>

  <div id="quiz-container" class="card">
    <div id="quiz">
      <div class="meta">
        <div>Question <span id="qnum">1</span>/<span id="qtotal">10</span></div>
        <div>Score <span id="scoreLive">0</span></div>
        <div>Player <span id="whoami" class="pill"></span></div>
        <div>Game <span id="gamePill" class="pill"></span></div>
      </div>

      <div id="question" class="question"></div>
      <ul id="options"></ul>

      <div id="leaderboardBox" class="card">
        <div style="font-weight:700; margin-bottom:6px;">Leaderboard</div>
        <div id="leaderboard" class="small">Connectingâ€¦</div>
      </div>

      <div id="explanation" class="explanation"></div>

      <div class="actions" style="justify-content:flex-end;">
        <button class="secondary" onclick="restart()">Restart</button>
        <button id="nextBtn" class="primary" onclick="nextQuestion()" disabled>Next</button>
      </div>
    </div>

    <div id="results">
      <h2>Finished!</h2>
      <div id="score"></div>
      <div class="small">Refresh or press Restart to try again.</div>
      <div class="actions" style="justify-content:center;">
        <button class="primary" onclick="restart()">Play again</button>
      </div>
    </div>
  </div>

  <script>
    // ---- CONFIG: your deployed Socket.IO server ----
    const SOCKET_SERVER_URL = "https://quiz-leaderboard-server-1.onrender.com";
    // ------------------------------------------------

    const quizData = [
      { q: "What is the capital of France?", opts: ["London", "Paris", "Berlin", "Madrid"], correct: 1, exp: "Paris is the capital and largest city of France." },
      { q: "Which continent is the largest by land area?", opts: ["Asia", "Africa", "North America", "Europe"], correct: 0, exp: "Asia covers about 30% of Earth's land area." },
      { q: "What is the longest river in the world?", opts: ["Amazon River", "Nile River", "Yangtze River", "Mississippi River"], correct: 1, exp: "The Nile River flows through northeastern Africa." },
      { q: "Which country has the most population?", opts: ["China", "United States", "India", "Indonesia"], correct: 2, exp: "India surpassed China in 2023 as the most populous nation." },
      { q: "What is the smallest country by land area?", opts: ["Monaco", "Nauru", "Tuvalu", "Vatican City"], correct: 3, exp: "Vatican City is an enclave within Rome, Italy." },
      { q: "Which ocean is the largest?", opts: ["Pacific Ocean", "Atlantic Ocean", "Indian Ocean", "Arctic Ocean"], correct: 0, exp: "The Pacific Ocean covers more than 30% of Earth's surface." },
      { q: "Mount Everest is located in which mountain range?", opts: ["Andes", "Himalayas", "Rockies", "Alps"], correct: 1, exp: "It forms the border between Nepal and China." },
      { q: "What is the capital of Australia?", opts: ["Sydney", "Melbourne", "Canberra", "Perth"], correct: 2, exp: "Canberra was chosen as a compromise between Sydney and Melbourne." },
      { q: "Which desert is the largest hot desert?", opts: ["Sahara Desert", "Gobi Desert", "Kalahari Desert", "Arabian Desert"], correct: 0, exp: "It spans much of northern Africa." },
      { q: "How many continents are there?", opts: ["5", "7", "6", "8"], correct: 1, exp: "The seven continents are Asia, Africa, North America, South America, Antarctica, Europe, and Australia." }
    ];

    // Constant QR code: no gameId in URL. Everyone scans the same URL and types the code.
    let gameCode = ""; // displayed code like "123-456"

    let idx = 0;
    let score = 0;
    let answered = false;
    let myName = "";

    const socket = io(SOCKET_SERVER_URL, { transports: ["websocket", "polling"] });

    socket.on("connect", () => setLeaderboardText("Connected. Create or join a game code."));
    socket.on("connect_error", () => setLeaderboardText("Cannot reach leaderboard server."));
    socket.on("leaderboardUpdate", (rows) => renderLeaderboard(rows));

    function setLeaderboardText(text) {
      const el = document.getElementById("leaderboard");
      if (el) el.textContent = text;
    }

    function renderLeaderboard(rows) {
      const el = document.getElementById("leaderboard");
      if (!el) return;

      if (!Array.isArray(rows) || rows.length === 0) {
        el.textContent = "No players yet.";
        return;
      }

      el.innerHTML = rows.map((r, i) => {
        const me = (r.name === myName) ? " (you)" : "";
        const progress = (typeof r.qIndex === "number") ? `Q${r.qIndex + 1}` : "";
        return `
          <div class="lb-row">
            <div>${i + 1}. ${escapeHtml(r.name)}${me}</div>
            <div><span class="pill">${r.score}</span> <span class="small">${progress}</span></div>
          </div>
        `;
      }).join("");
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    // Generates "123-456" (digits only, fixed length)
    function makeGameCode() {
      const six = String(Math.floor(Math.random() * 1000000)).padStart(6, "0");
      return six.slice(0, 3) + "-" + six.slice(3);
    }

    // Accepts "123456" or "123-456" and normalizes to "123-456"
    function normalizeGameCode(code) {
      const digits = String(code || "").replace(/\D/g, "");
      if (digits.length !== 6) return "";
      return digits.slice(0, 3) + "-" + digits.slice(3);
    }

    // Use digits-only as the Socket.IO room id ("123456")
    function roomIdFromGameCode(code) {
      return String(code || "").replace(/\D/g, "");
    }

    function updateGameUI() {
      document.getElementById("gameLabel").textContent = gameCode ? gameCode : "None";
      document.getElementById("gamePill").textContent = gameCode ? gameCode : "";
      const gi = document.getElementById("gameInput");
      if (gi && gameCode && !gi.value) gi.value = gameCode;
    }

    function createNewGame() {
      gameCode = makeGameCode();
      document.getElementById("gameInput").value = gameCode;
      updateGameUI();
      setLeaderboardText("Game created. Share the code, then press Start quiz.");
    }

    function useEnteredGame() {
      const typed = normalizeGameCode(document.getElementById("gameInput").value);
      if (!typed) { alert("Please enter a 6-digit code (123-456)"); return; }
      gameCode = typed;
      document.getElementById("gameInput").value = gameCode;
      updateGameUI();
      setLeaderboardText("Game selected. Press Start quiz.");
    }

    function renderQR() {
      const holder = document.getElementById("qrcode");
      const status = document.getElementById("qrStatus");
      holder.innerHTML = "";

      if (!window.QRCode) {
        status.textContent = "QRCode library did not load.";
        return;
      }

      // Constant QR code: always points to the same page URL (no game parameters).
      const url = window.location.origin + window.location.pathname;

      new QRCode(holder, {
        text: url,
        width: 220,
        height: 220,
        correctLevel: QRCode.CorrectLevel.M
      });

      status.textContent = "";
    }

    function startQuiz() {
      const input = document.getElementById("playerName");
      myName = (input.value || "").trim();
      if (!myName) { alert("Please enter your name"); return; }

      // Must have a game code
      if (!gameCode) {
        const typed = normalizeGameCode(document.getElementById("gameInput").value);
        if (!typed) { alert("Create a new game or type a 6-digit game code first"); return; }
        gameCode = typed;
      }
      updateGameUI();

      const gameId = roomIdFromGameCode(gameCode);

      document.getElementById("whoami").textContent = myName;

      // Join room
      socket.emit("joinGame", { gameId, playerName: myName });

      // Start UI
      document.getElementById("join-screen").style.display = "none";
      document.getElementById("quiz-container").style.display = "block";
      document.getElementById("qtotal").textContent = String(quizData.length);

      idx = 0;
      score = 0;
      document.getElementById("scoreLive").textContent = "0";
      document.getElementById("results").style.display = "none";
      document.getElementById("quiz").style.display = "block";

      // Push initial state so leaderboard shows them immediately
      socket.emit("scoreUpdate", { gameId, playerName: myName, score, qIndex: idx });

      loadQuestion();
    }

    function loadQuestion() {
      answered = false;

      const q = quizData[idx];
      document.getElementById("qnum").textContent = String(idx + 1);
      document.getElementById("question").textContent = q.q;

      const ul = document.getElementById("options");
      ul.innerHTML = "";

      q.opts.forEach((text, optIndex) => {
        const li = document.createElement("li");
        li.className = "option";
        li.textContent = String.fromCharCode(65 + optIndex) + ". " + text;
        li.addEventListener("click", () => choose(optIndex, li));
        ul.appendChild(li);
      });

      const exp = document.getElementById("explanation");
      exp.style.display = "none";
      exp.textContent = "";

      const nextBtn = document.getElementById("nextBtn");
      nextBtn.disabled = true;
      nextBtn.textContent = (idx === quizData.length - 1) ? "Finish" : "Next";

      // Update progress even before answering
      if (myName && gameCode) {
        const gameId = roomIdFromGameCode(gameCode);
        socket.emit("scoreUpdate", { gameId, playerName: myName, score, qIndex: idx });
      }
    }

    function choose(optIndex, element) {
      if (answered) return;
      answered = true;

      const q = quizData[idx];
      const all = Array.from(document.querySelectorAll("#options .option"));
      all.forEach(li => li.classList.add("disabled"));

      if (optIndex === q.correct) {
        element.classList.add("correct");
        score += 1;
        document.getElementById("scoreLive").textContent = String(score);
      } else {
        element.classList.add("incorrect");
        all[q.correct].classList.add("correct");
      }

      // Emit live score update after each question
      if (myName && gameCode) {
        const gameId = roomIdFromGameCode(gameCode);
        socket.emit("scoreUpdate", { gameId, playerName: myName, score, qIndex: idx });
      }

      const exp = document.getElementById("explanation");
      exp.textContent = q.exp;
      exp.style.display = "block";

      document.getElementById("nextBtn").disabled = false;
    }

    function nextQuestion() {
      if (!answered) return;

      idx += 1;
      if (idx >= quizData.length) showResults();
      else loadQuestion();
    }

    function showResults() {
      document.getElementById("quiz").style.display = "none";
      document.getElementById("results").style.display = "block";
      document.getElementById("score").textContent = score + "/" + quizData.length;

      // Final push
      if (myName && gameCode) {
        const gameId = roomIdFromGameCode(gameCode);
        socket.emit("scoreUpdate", { gameId, playerName: myName, score, qIndex: quizData.length });
      }
    }

    function restart() {
      document.getElementById("quiz-container").style.display = "none";
      document.getElementById("join-screen").style.display = "block";

      idx = 0; score = 0; answered = false; myName = "";
      document.getElementById("playerName").value = "";

      // Do not keep old game by default (forces new groups to create/join a code)
      gameCode = "";
      document.getElementById("gameInput").value = "";
      updateGameUI();

      setLeaderboardText("Connected. Create or join a game code.");
      renderQR();
    }

    // Optional: live formatting while typing (turn "123456" into "123-456")
    document.addEventListener("input", (e) => {
      if (e.target && e.target.id === "gameInput") {
        const digits = String(e.target.value || "").replace(/\D/g, "").slice(0, 6);
        if (digits.length <= 3) e.target.value = digits;
        else e.target.value = digits.slice(0,3) + "-" + digits.slice(3);
      }
    });

    window.addEventListener("load", () => {
      renderQR();
      updateGameUI();
    });
  </script>
</body>
</html>
